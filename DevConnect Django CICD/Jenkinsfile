pipeline {
    agent any

    triggers {
        pollSCM('*/10 * * * *')
    }

    stages {
        stage('Build and Test') {
            steps {
                // Checkout your source code
                checkout scm

                // Build the Docker image
                script {
                    dockerImage = docker.build("your-image-name:${env.BUILD_ID}")
                }

                // Run Django tests
                sh 'python manage.py test'

                // Additional tests (e.g., HTTP requests)
                sh 'curl -I http://your-app-url'

                // Archive test results
                archiveArtifacts '**/test-reports/*.xml'
            }
        }

        stage('Push Image') {
            when {
                expression { currentBuild.resultIsBetterOrEqualTo('SUCCESS') }
            }
            steps {
                // Push the Docker image to your container registry
                script {
                    dockerImage.push()
                }
            }
        }

        stage('Deploy to Kubernetes') {
            when {
                expression { currentBuild.resultIsBetterOrEqualTo('SUCCESS') }
            }
            steps {
                // Deploy the updated app to your production Kubernetes cluster
                // You'll need kubectl configured with credentials for the cluster
                sh 'kubectl apply -f your-k8s-deployment.yaml'
            }
        }
    }

    post {
        failure {
            echo 'The pipeline failed :('
        }
    }
}
